apiVersion: v2
parts:
  - name: version-check
    description: |-
      A mismatch here means you may be using the wrong reference.
      This reference was designed for OpenShift 4.20.
    components:
      - name: version-check
        allOf:
          - path: version-check/ClusterVersionOperator.yaml
            config:
              ignore-unspecified-fields: true
              fieldsToOmitRefs:
                - allowStatusCheck
  - name: defaults-check
    description: |-
      A mismatch here means you are overriding expected default
      values in Openshift configuration
    components:
      - name: defaults-required
        allOf:
          - path: machine-config/cgroup-check.yaml
      - name: defaults-optional
        # If the matching CR exists it needs to match expected content
        anyOf:
          - path: machine-config/container-runtime.yaml
  - name: required-cluster-logging
    description: |-
      https://docs.openshift.com/container-platform/4.20/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-logging_ran-ref-design-components
    components:
      - name: cluster-logging
        allOf:
          - path: cluster-logging/ClusterLogNS.yaml
          - path: cluster-logging/ClusterLogOperGroup.yaml
          - path: cluster-logging/ClusterLogSubscription.yaml
            config:
              ignore-unspecified-fields: true
          - path: cluster-logging/ClusterLogForwarder.yaml
          - path: cluster-logging/ClusterLogServiceAccount.yaml
          - path: cluster-logging/ClusterLogServiceAccountAuditBinding.yaml
          - path: cluster-logging/ClusterLogServiceAccountInfrastructureBinding.yaml
  - name: required-cluster-tuning
    description: |-
      https://docs.openshift.com/container-platform/4.20/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-cluster-tuning_ran-ref-design-components
    components:
      - name: cluster-tuning
        allOf:
          - path: cluster-tuning/disabling-network-diagnostics/DisableSnoNetworkDiag.yaml
            config:
              ignore-unspecified-fields: true
          - path: cluster-tuning/monitoring-configuration/ReduceMonitoringFootprint.yaml
            config:
              perField:
                - pathToKey: data."config.yaml"
                  inlineDiffFunc: capturegroups
          - path: cluster-tuning/operator-hub/DefaultCatsrc.yaml
          - path: cluster-tuning/09-openshift-marketplace-ns.yaml
          - path: cluster-tuning/operator-hub/DisconnectedIDMS.yaml
      - name: optional-cluster-tuning
        anyOf:
          - path: cluster-tuning/operator-hub/OperatorHub.yaml
          - path: cluster-tuning/DisableOLMPprof.yaml
  - name: optional-lca
    description: |-
      https://docs.openshift.com/container-platform/4.20/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-lca-operator_ran-ref-design-components
    components:
      - name: lca
        allOrNoneOf:
          - path: lca/LcaSubscription.yaml
          - path: lca/LcaSubscriptionNS.yaml
          - path: lca/LcaSubscriptionOperGroup.yaml
  - name: optional-nmstate-operator
    description: |-
      The nmstate operator is only used in multinode clusters when required by IPSec:
        https://docs.openshift.com/container-platform/4.20/edge_computing/ztp-deploying-far-edge-sites.html#ztp-configuring-ipsec-using-ztp-and-siteconfig-for-mno_ztp-deploying-far-edge-sites
    components:
      - name: nmstate-operator
        allOrNoneOf:
          - path: nmstate/NMStateSubscription.yaml
          - path: nmstate/NMStateSubscriptionNS.yaml
          - path: nmstate/NMStateSubscriptionOperGroup.yaml
      - name: nmstate-config
        anyOf:
          - path: nmstate/NMState.yaml
  - name: required-machine-config
    description: |-
      https://docs.openshift.com/container-platform/4.20/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-machine-configuration_ran-ref-design-components
    components:
      - name: machine-config
        allOf:
          - path: machine-config/kubelet-configuration-and-container-mount-hiding/01-container-mount-ns-and-kubelet-conf-master.yaml
          - path: machine-config/kubelet-configuration-and-container-mount-hiding/01-container-mount-ns-and-kubelet-conf-worker.yaml
          - path: machine-config/one-shot-time-sync/99-sync-time-once-master.yaml
          - path: machine-config/one-shot-time-sync/99-sync-time-once-worker.yaml
          - path: machine-config/sctp/03-sctp-machine-config-master.yaml
          - path: machine-config/sctp/03-sctp-machine-config-worker.yaml
          - path: machine-config/set-rcu-normal/08-set-rcu-normal-master.yaml
          - path: machine-config/set-rcu-normal/08-set-rcu-normal-worker.yaml
          - path: machine-config/sriov-related-kernel-arguments/07-sriov-related-kernel-args-master.yaml
          - path: machine-config/sriov-related-kernel-arguments/07-sriov-related-kernel-args-worker.yaml
          - path: machine-config/crun/enable-crun-master.yaml
          - path: machine-config/crun/enable-crun-worker.yaml
          - path: machine-config/kdump/06-kdump-master.yaml
          - path: machine-config/kdump/06-kdump-worker.yaml
      - name: optional machine-configs
        anyOf:
          - path: machine-config/01-disk-encryption-pcr-rebind-master.yaml
          - path: machine-config/01-disk-encryption-pcr-rebind-worker.yaml
  - name: required-node-tuning-operator
    description: |-
      https://docs.openshift.com/container-platform/4.20/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-node-tuning-operator_ran-ref-design-components
    components:
      - name: node-tuning-operator
        allOf:
          - path: node-tuning-operator/PerformanceProfile.yaml
          - path: node-tuning-operator/TunedPerformancePatch.yaml
      - name: optional node-tuning-operator
        anyOf:
          - path: node-tuning-operator/TunedPowerCustom.yaml
            config:
              perField:
                - pathToKey: spec.profile.0.data
                  inlineDiffFunc: capturegroups
  - name: required-ptp-operator
    description: |-
      https://docs.openshift.com/container-platform/4.20/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-ptp-operator_ran-ref-design-components
    components:
      - name: ptp-operator
        allOf:
          - path: ptp-operator/PtpSubscription.yaml
            config:
              ignore-unspecified-fields: true
          - path: ptp-operator/PtpSubscriptionNS.yaml
          - path: ptp-operator/PtpSubscriptionOperGroup.yaml
  - name: required-sriov-operator
    description: |-
      https://docs.openshift.com/container-platform/4.20/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-sr-iov-operator_ran-ref-design-components
    components:
      - name: sriov-operator
        allOf:
          - path: sriov-operator/SriovNetwork.yaml
          - path: sriov-operator/SriovNetworkNodePolicy.yaml
          - path: sriov-operator/SriovSubscription.yaml
            config:
              ignore-unspecified-fields: true
          - path: sriov-operator/SriovSubscriptionNS.yaml
          - path: sriov-operator/SriovSubscriptionOperGroup.yaml
      - name: sriov-operator-config
        oneOf:
          - path: sriov-operator/SriovOperatorConfig.yaml
          - path: sriov-operator/SriovOperatorConfigForSNO.yaml
  - name: optional-storage-lso
    description: |-
      https://docs.openshift.com/container-platform/4.20/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-storage-lso_ran-ref-design-components
    components:
      - name: storage-lso
        allOrNoneOf:
          - path: storage-lso/StorageNS.yaml
          - path: storage-lso/StorageOperGroup.yaml
          - path: storage-lso/StorageSubscription.yaml
            config:
              ignore-unspecified-fields: true
  - name: optional-storage-lvm
    description: |-
      https://docs.openshift.com/container-platform/4.20/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-lvms-operator_ran-ref-design-components
    components:
      - name: storage-operator
        allOrNoneOf:
          - path: storage-lvm/StorageLVMCluster.yaml
          - path: storage-lvm/StorageLVMSubscription.yaml
            config:
              ignore-unspecified-fields: true
          - path: storage-lvm/StorageLVMSubscriptionNS.yaml
          - path: storage-lvm/StorageLVMSubscriptionOperGroup.yaml
          - path: storage-lvm/StoragePV.yaml
  - name: optional-storage-config
    description: |-
      https://docs.openshift.com/container-platform/4.20/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-lvms-operator_ran-ref-design-components
    components:
      - name: local-storage-config
        anyOf:
          - path: storage-lvm/StoragePVC.yaml
  - name: optional-storage
    description: |-
      https://docs.openshift.com/container-platform/4.20/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-storage-lso_ran-ref-design-components
    components:
      - name: storage
        allOrNoneOf:
          - path: storage-lso/StorageClass.yaml
            config:
              ignore-unspecified-fields: true
          - path: storage/StorageLV.yaml
            config:
              ignore-unspecified-fields: true
  - name: optional-sriov-fec-operator
    description: |-
      https://docs.openshift.com/container-platform/4.20/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-sriov-fec-operator_ran-ref-design-components
    components:
      - name: sriov-fec-operator
        allOrNoneOf:
          - path: sriov-fec-operator/AcceleratorsNS.yaml
          - path: sriov-fec-operator/AcceleratorsOperGroup.yaml
          - path: sriov-fec-operator/AcceleratorsSubscription.yaml
            config:
              ignore-unspecified-fields: true
      - name: sriov-fec-config
        anyOf:
          - path: sriov-fec-operator/SriovFecClusterConfig.yaml
          - path: sriov-fec-operator/SriovVrbClusterConfig.yaml
  - name: optional-image-registry
    description: |-
      https://docs.openshift.com/container-platform/4.20/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-lca-operator_ran-ref-design-components
    components:
      - name: image-registry
        allOrNoneOf:
          - path: image-registry/ImageRegistryConfig.yaml
          - path: image-registry/ImageRegistryPV.yaml
  - name: optional-ptp-config
    description: |-
      https://docs.openshift.com/container-platform/4.20/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-ptp-operator_ran-ref-design-components
    components:
      - name: ptp-operator-config
        oneOf:
          - path: ptp-operator/configuration/PtpOperatorConfig.yaml
          - path: ptp-operator/configuration/PtpOperatorConfigForEvent.yaml
      - name: ptp-config
        oneOf:
          # TODO: the INI files embedded in PtpConfig objects are not handled. CNF-13528
          - path: ptp-operator/configuration/PtpConfigBoundary.yaml
            config:
              perField:
                - pathToKey: spec.profile.0.phc2sysOpts
                  inlineDiffFunc: capturegroups
                - pathToKey: spec.profile.0.ptp4lConf
                  inlineDiffFunc: capturegroups
          - path: ptp-operator/configuration/PtpConfigGmWpc.yaml
            config:
              perField:
                - pathToKey: spec.profile.0.phc2sysOpts
                  inlineDiffFunc: capturegroups
                - pathToKey: spec.profile.0.ts2phcConf
                  inlineDiffFunc: capturegroups
                - pathToKey: spec.profile.0.ptp4lConf
                  inlineDiffFunc: capturegroups
          - path: ptp-operator/configuration/PtpConfigDualCardGmWpc.yaml
            config:
              perField:
                - pathToKey: spec.profile.0.phc2sysOpts
                  inlineDiffFunc: capturegroups
                - pathToKey: spec.profile.0.ts2phcConf
                  inlineDiffFunc: capturegroups
                - pathToKey: spec.profile.0.ptp4lConf
                  inlineDiffFunc: capturegroups
          - path: ptp-operator/configuration/PtpConfigDualFollower.yaml
            config:
              perField:
                - pathToKey: spec.profile.0.phc2sysOpts
                  inlineDiffFunc: capturegroups
                - pathToKey: spec.profile.0.ts2phcConf
                  inlineDiffFunc: capturegroups
                - pathToKey: spec.profile.0.ptp4lConf
                  inlineDiffFunc: capturegroups
          - path: ptp-operator/configuration/PtpConfigThreeCardGmWpc.yaml
            config:
              perField:
                - pathToKey: spec.profile.0.phc2sysOpts
                  inlineDiffFunc: capturegroups
                - pathToKey: spec.profile.0.ts2phcConf
                  inlineDiffFunc: capturegroups
                - pathToKey: spec.profile.0.ptp4lConf
                  inlineDiffFunc: capturegroups
          - path: ptp-operator/configuration/PtpConfigForHA.yaml
            config:
              perField:
                - pathToKey: spec.profile.0.phc2sysOpts
                  inlineDiffFunc: capturegroups
          - path: ptp-operator/configuration/PtpConfigMaster.yaml
            config:
              perField:
                - pathToKey: spec.profile.0.phc2sysOpts
                  inlineDiffFunc: capturegroups
                - pathToKey: spec.profile.0.ptp4lConf
                  inlineDiffFunc: capturegroups
          - path: ptp-operator/configuration/PtpConfigSlave.yaml
            config:
              perField:
                - pathToKey: spec.profile.0.phc2sysOpts
                  inlineDiffFunc: capturegroups
                - pathToKey: spec.profile.0.ptp4lConf
                  inlineDiffFunc: capturegroups
          # TODO: If one of these 4 is selected, they should be paired with 'PtpOperatorConfigForEvent.yaml' above
          - path: ptp-operator/configuration/PtpConfigSlaveForEvent.yaml
            config:
              perField:
                - pathToKey: spec.profile.0.phc2sysOpts
                  inlineDiffFunc: capturegroups
                - pathToKey: spec.profile.0.ptp4lConf
                  inlineDiffFunc: capturegroups
          - path: ptp-operator/configuration/PtpConfigForHAForEvent.yaml
            config:
              perField:
                - pathToKey: spec.profile.0.phc2sysOpts
                  inlineDiffFunc: capturegroups
          - path: ptp-operator/configuration/PtpConfigMasterForEvent.yaml
            config:
              perField:
                - pathToKey: spec.profile.0.phc2sysOpts
                  inlineDiffFunc: capturegroups
                - pathToKey: spec.profile.0.ptp4lConf
                  inlineDiffFunc: capturegroups
          - path: ptp-operator/configuration/PtpConfigBoundaryForEvent.yaml
            config:
              perField:
                - pathToKey: spec.profile.0.phc2sysOpts
                  inlineDiffFunc: capturegroups
                - pathToKey: spec.profile.0.ptp4lConf
                  inlineDiffFunc: capturegroups
  - name: optional-console-disable
    description: |-
      https://docs.openshift.com/container-platform/4.20/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-cluster-tuning_ran-ref-design-components
    components:
      - name: console-disable
        allOrNoneOf:
          - path: cluster-tuning/console-disable/ConsoleOperatorDisable.yaml
  - name: fetch-only
    description: |-
      These objects are only included so they are available to 'lookupCRs' functions in other templates; contents is not validated.
    components:
      - name: fetch-only
        anyOf:
          - path: fetch-only/Node.yaml

templateFunctionFiles:
  - functions/validate_node_selector.tmpl
  - functions/unordered_list.tmpl
  - functions/version_match.tmpl
  - functions/must_match_one_of.tmpl

fieldsToOmit:
  defaultOmitRef: all
  items:
    defaults:
      - pathToKey: metadata.annotations."kubernetes.io/metadata.name"
      - pathToKey: metadata.annotations."openshift.io/sa.scc.uid-range"
      - pathToKey: metadata.annotations."kubernetes.io/metadata.name"
      - pathToKey: metadata.annotations."openshift.io/sa.scc.mcs"
      - pathToKey: metadata.annotations."openshift.io/sa.scc.supplemental-groups"
      - pathToKey: metadata.annotations."kubectl.kubernetes.io/last-applied-configuration"
      - pathToKey: metadata.annotations."ran.openshift.io/ztp-deploy-wave"
      - pathToKey: metadata.annotations."machineconfiguration.openshift.io/mc-name-suffix"
      - pathToKey: metadata.annotations."security.openshift.io/MinimallySufficientPodSecurityStandard"
      - pathToKey: metadata.labels."kubernetes.io/metadata.name"
      - pathToKey: metadata.labels."olm.operatorgroup.uid"
      - pathToKey: metadata.labels."security.openshift.io/scc.podSecurityLabelSync"
      - pathToKey: metadata.resourceVersion
      - pathToKey: metadata.uid
      - pathToKey: spec.finalizers
      - pathToKey: metadata.creationTimestamp
      - pathToKey: metadata.generation
      - pathToKey: metadata.finalizers
      - pathToKey: metadata.annotations."ran.openshift.io/ztp-gitops-generated"
      - pathToKey: spec.ownerReferences
      - pathToKey: metadata.ownerReferences
      - pathToKey: metadata.annotations."include.release.openshift.io/ibm-cloud-managed"
      - pathToKey: metadata.annotations."include.release.openshift.io/self-managed-high-availability"
      - pathToKey: metadata.annotations."include.release.openshift.io/single-node-developer"
      - pathToKey: metadata.annotations."release.openshift.io/create-only"
      - pathToKey: metadata.labels."lca.openshift.io/target-ocp-version"
      - pathToKey: metadata.labels."pod-security.kubernetes.io/"
        isPrefix: true
      - pathToKey: metadata.annotations."capability.openshift.io/name"
      - pathToKey: metadata.annotations."olm.providedAPIs"
      - pathToKey: metadata.annotations."operator.sriovnetwork.openshift.io/last-network-namespace"
      - pathToKey: metadata.annotations."include.release.openshift.io/hypershift"
      - pathToKey: metadata.labels."olm.operatorgroup.uid/"
        isPrefix: true
    allowStatusCheck:
      - include: defaults
    all:
      - include: defaults
      - pathToKey: status
