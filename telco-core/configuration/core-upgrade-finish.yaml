---
apiVersion: policy.open-cluster-management.io/v1
kind: PolicyGenerator
metadata:
  name: core-upgrade-finish
policyDefaults:
  namespace: ztp-core-policies
  policySets: []
  placement:
    clusterSelectors:
      common: "core"
      upgrade-finish: ""
  remediationAction: "inform"
policies:
  - name: core-upgrade-workers-1
    policyAnnotations:
      # Ensure propagation time
      ran.openshift.io/soak-seconds: "30"
    manifests:
      - path: reference-crs/custom-manifests/mcp-worker-1.yaml
        patches:
        - spec:
            # Using 100% maxUnavailable for the MCP requires the cluster and workload to be designed for
            # multiple nodes to be offline simultaneously. This includes sufficient spare capacity, labeling for 
            # zones to spread replicas, and workload dimensioning to ensure service availability is retained. 
            # See https://github.com/openshift-kni/telco-reference/tree/main/telco-core/configuration#worker-node-upgrade for more details.
            maxUnavailable: 100%
            paused: false
          status:
            conditions:
            - type: Updated
              status: "True"
            - type: Updating
              status: "False"

  - name: core-upgrade-workers-2
    policyAnnotations:
      # Ensure propagation time
      ran.openshift.io/soak-seconds: "30"
    manifests:
      - path: reference-crs/custom-manifests/mcp-worker-2.yaml
        patches:
        - spec:
            maxUnavailable: 100%
            paused: false
          status:
            conditions:
            - type: Updated
              status: "True"
            - type: Updating
              status: "False"

  - name: core-upgrade-workers-3
    policyAnnotations:
      # Ensure propagation time
      ran.openshift.io/soak-seconds: "30"
    manifests:
      - path: reference-crs/custom-manifests/mcp-worker-3.yaml
        patches:
        - spec:
            maxUnavailable: 100%
            paused: false
          status:
            conditions:
            - type: Updated
              status: "True"
            - type: Updating
              status: "False"
